#!/bin/bash
# checkpoint-status - Check backup status and health

set -e

WORKSPACE_DIR="${WORKSPACE_DIR:-$HOME/.openclaw/workspace}"
AGENTS_DIR="${HOME}/.openclaw/agents"
AGENTS_BACKUP_DIR="${WORKSPACE_DIR}/agents"

cd "$WORKSPACE_DIR" || {
    echo "âŒ Workspace not found at $WORKSPACE_DIR"
    exit 1
}

# Check if git repo exists
if [ ! -d ".git" ]; then
    echo "âŒ Not a git repository. Run 'checkpoint-init' first."
    exit 1
fi

echo "ðŸ“Š OpenClaw Checkpoint Status"
echo "=============================="
echo ""

# Repository info
echo "ðŸ“ Repository:"
echo "   Location: $WORKSPACE_DIR"
if git remote get-url origin >/dev/null 2>&1; then
    REMOTE=$(git remote get-url origin)
    echo "   Remote: $REMOTE"
else
    echo "   Remote: âŒ Not configured"
fi

echo ""

# Last backup
echo "ðŸ’¾ Last Backup:"
LAST_COMMIT=$(git log -1 --format="%H" 2>/dev/null || echo "")
if [ -n "$LAST_COMMIT" ]; then
    LAST_TIME=$(git log -1 --format="%cd" --date=iso)
    LAST_RELATIVE=$(git log -1 --format="%cd" --date=relative)
    LAST_MSG=$(git log -1 --format="%s")
    echo "   Time: $LAST_TIME ($LAST_RELATIVE)"
    echo "   Commit: ${LAST_COMMIT:0:8}"
    echo "   Message: $LAST_MSG"
    
    # Check if we're behind remote
    git fetch origin main --quiet 2>/dev/null || true
    LOCAL=$(git rev-parse @ 2>/dev/null || echo "")
    REMOTE=$(git rev-parse origin/main 2>/dev/null || echo "")
    
    if [ "$LOCAL" != "$REMOTE" ] && [ -n "$REMOTE" ]; then
        BEHIND=$(git rev-list HEAD..origin/main --count 2>/dev/null || echo "0")
        echo "   âš ï¸  Behind remote by $BEHIND commit(s)"
        echo "      Run: checkpoint-restore"
    else
        echo "   âœ… Up to date with remote"
    fi
else
    echo "   âŒ No backups yet"
fi

echo ""

# Check for uncommitted changes
echo "ðŸ“ Local Changes:"
if ! git diff --quiet HEAD 2>/dev/null || ! git diff --cached --quiet 2>/dev/null; then
    CHANGED=$(git status --short | wc -l)
    echo "   âš ï¸  $CHANGED file(s) with uncommitted changes"
    echo "      Run: checkpoint-backup"
else
    echo "   âœ… No uncommitted changes"
fi

echo ""

# Auto-backup schedule
echo "â° Auto-Backup Schedule:"
if [[ "$OSTYPE" == darwin* ]]; then
    # macOS - check launchd
    PLIST="$HOME/Library/LaunchAgents/com.openclaw.checkpoint.plist"
    if [ -f "$PLIST" ]; then
        if launchctl list | grep -q "com.openclaw.checkpoint"; then
            INTERVAL=$(grep -A1 "StartInterval" "$PLIST" | grep integer | sed 's/[^0-9]//g')
            case "$INTERVAL" in
                900) FREQ="Every 15 minutes" ;;
                1800) FREQ="Every 30 minutes" ;;
                3600) FREQ="Every hour" ;;
                7200) FREQ="Every 2 hours" ;;
                14400) FREQ="Every 4 hours" ;;
                86400) FREQ="Daily" ;;
                *) FREQ="Every $((INTERVAL / 60)) minutes" ;;
            esac
            echo "   âœ… $FREQ (via launchd)"
            echo "   Logs: ~/.openclaw/logs/checkpoint.log"
        else
            echo "   âš ï¸  Configured but not running"
            echo "      Run: launchctl load ~/Library/LaunchAgents/com.openclaw.checkpoint.plist"
        fi
    else
        echo "   âŒ Not scheduled"
        echo "      Run: checkpoint-schedule hourly"
    fi
else
    # Linux - check cron
    if crontab -l 2>/dev/null | grep -q "openclaw-checkpoint"; then
        CRON_LINE=$(crontab -l 2>/dev/null | grep "openclaw-checkpoint")
        echo "   âœ… Scheduled (via cron)"
        echo "   Entry: $CRON_LINE"
    else
        echo "   âŒ Not scheduled"
        echo "      Run: checkpoint-schedule hourly"
    fi
fi

echo ""

# Agent backup status
echo "ðŸ¤– Agents:"
BACKED_UP_AGENTS=()
LOCAL_AGENTS=()

# Check which agents are backed up in the repo
if [ -d "$AGENTS_BACKUP_DIR" ]; then
    for d in "$AGENTS_BACKUP_DIR"/*/; do
        [ -d "$d" ] && BACKED_UP_AGENTS+=("$(basename "$d")")
    done
fi

# Check which agents exist locally
if [ -d "$AGENTS_DIR" ]; then
    for d in "$AGENTS_DIR"/*/; do
        [ -d "$d" ] && LOCAL_AGENTS+=("$(basename "$d")")
    done
fi

if [ ${#BACKED_UP_AGENTS[@]} -eq 0 ] && [ ${#LOCAL_AGENTS[@]} -eq 0 ]; then
    echo "   â„¹ï¸  No agents found (local or backed up)"
else
    if [ ${#BACKED_UP_AGENTS[@]} -gt 0 ]; then
        echo "   Backed up: ${BACKED_UP_AGENTS[*]}"
    fi

    # Find agents that exist locally but are NOT backed up
    NOT_BACKED_UP=()
    for local_agent in "${LOCAL_AGENTS[@]}"; do
        found=false
        for backed_agent in "${BACKED_UP_AGENTS[@]}"; do
            if [ "$local_agent" = "$backed_agent" ]; then
                found=true
                break
            fi
        done
        if [ "$found" = false ]; then
            NOT_BACKED_UP+=("$local_agent")
        fi
    done

    if [ ${#NOT_BACKED_UP[@]} -gt 0 ]; then
        echo "   âš ï¸  Not yet backed up: ${NOT_BACKED_UP[*]}"
        echo "      Run: checkpoint-backup"
    elif [ ${#LOCAL_AGENTS[@]} -gt 0 ]; then
        echo "   âœ… All ${#LOCAL_AGENTS[@]} local agent(s) backed up"
    fi
fi

echo ""

# Recent log entries (if log exists)
LOG_FILE="$HOME/.openclaw/logs/checkpoint.log"
if [ -f "$LOG_FILE" ]; then
    echo "ðŸ“œ Recent Backup Activity:"
    tail -5 "$LOG_FILE" 2>/dev/null | sed 's/^/   /' || echo "   (log file exists but is empty)"
else
    echo "ðŸ“œ Recent Backup Activity:"
    echo "   (no log file yet)"
fi

echo ""
echo "=============================="
echo "ðŸ’¡ Quick Actions:"
echo "   checkpoint-backup           - Backup now"
echo "   checkpoint-restore           - Restore from remote"
echo "   checkpoint-auth             - Fix authentication issues"
echo "   checkpoint-schedule hourly  - Set auto-backup (or 15min, 30min, daily, etc.)"
echo "   checkpoint-schedule disable - Turn off automatic backups"
echo "   checkpoint-stop             - Stop automatic backups"
echo "   checkpoint-status           - Show this status"
