#!/bin/bash
# checkpoint - Save OpenClaw state to remote repository

set -e

WORKSPACE_DIR="${WORKSPACE_DIR:-$HOME/.openclaw/workspace}"
REMOTE_URL="${CHECKPOINT_REMOTE:-origin}"
BRANCH="${CHECKPOINT_BRANCH:-main}"
LOCK_DIR="$WORKSPACE_DIR/.git/checkpoint.lock"

cd "$WORKSPACE_DIR" || {
    echo "‚ùå Workspace not found at $WORKSPACE_DIR"
    exit 1
}

# Check if git repo exists
if [ ! -d ".git" ]; then
    echo "‚ùå Not a git repository. Run 'checkpoint-init' first."
    exit 1
fi

# Prevent concurrent runs using mkdir (atomic on all platforms)
cleanup_lock() {
    rmdir "$LOCK_DIR" 2>/dev/null || true
}
trap cleanup_lock EXIT

if ! mkdir "$LOCK_DIR" 2>/dev/null; then
    # Check if lock is stale (older than 5 minutes)
    if [[ "$OSTYPE" == darwin* ]]; then
        LOCK_AGE=$(( $(date +%s) - $(stat -f %m "$LOCK_DIR" 2>/dev/null || echo 0) ))
    else
        LOCK_AGE=$(( $(date +%s) - $(stat -c %Y "$LOCK_DIR" 2>/dev/null || echo 0) ))
    fi
    if [ "$LOCK_AGE" -gt 300 ]; then
        echo "üîì Removing stale lock (${LOCK_AGE}s old)"
        rmdir "$LOCK_DIR" 2>/dev/null || true
        mkdir "$LOCK_DIR" 2>/dev/null || { echo "‚è≥ Another checkpoint is running, skipping"; exit 0; }
    else
        echo "‚è≥ Another checkpoint is already running, skipping"
        exit 0
    fi
fi

# Check if there are changes (staged, unstaged, or untracked)
if git diff --quiet HEAD 2>/dev/null && git diff --cached --quiet 2>/dev/null && [ -z "$(git status --porcelain 2>/dev/null)" ]; then
    echo "‚è≠Ô∏è  No changes to checkpoint"
    exit 0
fi

# Add all changes
echo "üíæ Saving checkpoint..."
git add -A

# Commit with timestamp
git commit -m "checkpoint: $(date '+%Y-%m-%d %H:%M')" --quiet

# Push to remote
echo "‚òÅÔ∏è  Pushing to $REMOTE_URL/$BRANCH..."
if git push "$REMOTE_URL" "$BRANCH" --quiet; then
    echo "‚úÖ Checkpoint saved successfully"
    echo "   Time: $(date '+%Y-%m-%d %H:%M:%S')"
    echo "   Commit: $(git rev-parse --short HEAD)"
else
    echo "‚ùå Failed to push checkpoint"
    echo "   You may need to pull first: checkpoint-resume"
    exit 1
fi
