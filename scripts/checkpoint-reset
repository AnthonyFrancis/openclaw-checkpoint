#!/bin/bash
# checkpoint-reset - Reset checkpoint system for fresh setup

set -e

WORKSPACE_DIR="${WORKSPACE_DIR:-$HOME/.openclaw/workspace}"

echo "ğŸ”„ OpenClaw Checkpoint Reset"
echo "=============================="
echo ""
echo "This will reset your checkpoint system so you can start fresh."
echo ""
echo "What would you like to reset?"
echo ""
echo "   1) Local git repository only (keep SSH keys)"
echo "   2) Everything (git repo + SSH keys + known_hosts)"
echo "   3) Cancel"
echo ""
read -p "Choose [1-3]: " RESET_CHOICE

case "$RESET_CHOICE" in
    1)
        echo ""
        echo "ğŸ—‘ï¸  Removing local git repository..."
        if [ -d "$WORKSPACE_DIR/.git" ]; then
            rm -rf "$WORKSPACE_DIR/.git"
            echo "   âœ… Git repository removed"
        else
            echo "   â­ï¸  No git repository found"
        fi
        ;;
    2)
        echo ""
        echo "ğŸ—‘ï¸  Removing local git repository..."
        if [ -d "$WORKSPACE_DIR/.git" ]; then
            rm -rf "$WORKSPACE_DIR/.git"
            echo "   âœ… Git repository removed"
        else
            echo "   â­ï¸  No git repository found"
        fi
        
        echo ""
        echo "ğŸ”‘ Removing SSH keys..."
        if [ -f "$HOME/.ssh/id_ed25519" ]; then
            rm -f "$HOME/.ssh/id_ed25519" "$HOME/.ssh/id_ed25519.pub"
            echo "   âœ… SSH keys removed"
        else
            echo "   â­ï¸  No SSH keys found"
        fi
        
        echo ""
        echo "ğŸŒ Removing known_hosts..."
        if [ -f "$HOME/.ssh/known_hosts" ]; then
            # Only remove github.com entry, not the whole file
            if grep -q "github.com" "$HOME/.ssh/known_hosts" 2>/dev/null; then
                grep -v "github.com" "$HOME/.ssh/known_hosts" > "$HOME/.ssh/known_hosts.tmp" 2>/dev/null || true
                mv "$HOME/.ssh/known_hosts.tmp" "$HOME/.ssh/known_hosts" 2>/dev/null || rm -f "$HOME/.ssh/known_hosts"
                echo "   âœ… GitHub removed from known_hosts"
            else
                echo "   â­ï¸  GitHub not in known_hosts"
            fi
        else
            echo "   â­ï¸  No known_hosts file found"
        fi
        ;;
    3)
        echo ""
        echo "   Cancelled."
        exit 0
        ;;
    *)
        echo ""
        echo "   âŒ Invalid option"
        exit 1
        ;;
esac

echo ""
echo "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
echo "â”‚  ğŸ“ Don't forget to delete your GitHub repo too!        â”‚"
echo "â”‚                                                         â”‚"
echo "â”‚  Go to: https://github.com/YOURUSER/REPO/settings       â”‚"
echo "â”‚  Scroll to 'Danger Zone' â†’ 'Delete this repository'     â”‚"
echo "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"
echo ""
echo "=============================="
echo "âœ… Reset complete!"
echo ""
echo "To start fresh, run:"
echo "   checkpoint-setup"
echo ""
